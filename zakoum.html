<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEO-SOVEREIGN ‚Äî Zakouma</title>

  <!-- Leaflet + Chart.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- GeoTIFF / GeoRaster / GeoRasterLayer (ordre important) -->
  <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster@1.7.1/dist/georaster.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster-layer-for-leaflet@3.9.0/dist/georaster-layer-for-leaflet.min.js"></script>

  <!-- CesiumJS -->
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#0f172a; --panel:#1e293b; --panel-2:#334155; --txt:#e2e8f0; --muted:#94a3b8; --brand:#38bdf8; }
    * { box-sizing: border-box; }
    body { background:var(--bg); color:var(--txt); display:flex; flex-direction:column; height:100vh; overflow:hidden; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; }
    header { background:var(--bg); padding:12px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--panel); }
    .header-left { display:flex; align-items:center; gap:12px; }
    .logo-flag { width:90px; border-radius:6px; }
    .logo-observatoire h1 { color:var(--brand); font-size:22px; margin:0 0 2px; }
    .logo-observatoire .subtitle { font-size:12px; color:var(--muted); }
    .header-right { text-align:right; font-size:12px; color:var(--muted); }
    .status { color:#4ade80; font-weight:700; display:block; }

    .main { display:flex; flex:1; overflow:hidden; position:relative; height: calc(100vh - 64px); }

    .sidebar { width:320px; background:var(--panel); padding:18px; overflow-y:auto; transition: width .3s ease; }
    .sidebar.collapsed { width: 60px; }
    .sidebar h2 { font-size:15px; color:#60a5fa; margin:10px 0 6px; }
    .group { background:var(--panel-2); padding:10px; border-radius:10px; margin-bottom:10px; }
    .group label { display:flex; gap:8px; align-items:center; margin:6px 0; font-size:14px; }
    .export-btn-container button, .sidebar button { width:100%; background: var(--panel-2); color: var(--txt); border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }

    #toggleSidebarBtn { position: fixed; top: 80px; left: 10px; z-index: 1100; background: var(--panel); color: var(--txt); border: none; padding: 8px 12px; border-radius: 6px; font-size: 20px; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,.3); }

    .content{
      flex: 1;
      height: 100%;
      display: grid;
      grid-template-rows: 1fr 220px;
      gap: 8px;
      padding: 0;
      overflow: hidden;
    }

    .viewport{
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: #0b1222;
    }

    #map, #cesiumContainer{
      position:absolute; inset:0; width:100%; height:100%;
    }

    /* Cesium 100% */
    #cesiumContainer,
    #cesiumContainer .cesium-viewer,
    #cesiumContainer .cesium-widget,
    #cesiumContainer canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }

    /* Bande d‚Äôinfos compacte */
    #infosGeoTechCompact{
      position: fixed;
      left: 12px;
      bottom: 8px;
      z-index: 1100;
      background: var(--panel);
      color: var(--muted);
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .map-overlays{
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1200;
      display: flex;
      gap: 12px;
      background: rgba(30,41,59,.85);
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--panel-2);
    }
    .map-overlays label{
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      white-space: nowrap;
    }

    .btn-float{
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1300;
      background: var(--panel);
      color: var(--txt);
      border: 1px solid var(--panel-2);
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.35);
    }

    .bottom-row{
      grid-row: 2;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
      gap: 8px;
      overflow: auto;
    }
    .filters-box, .dashboard-boxes, .chart-box { background: var(--panel); border-radius:10px; padding: 10px 12px; }
    .dashboard-boxes { display:flex; flex-direction:column; gap:8px; }
    .dashboard-box { text-align:center; }
    .dashboard-box .percentage { font-size: 18px; color:#38bdf8; }
    .dashboard-box .label { font-size:12px; color:#cbd5e1; }

    .chart-box canvas,
    #modalChart canvas {
      height: 140px !important;
      width: 100%;
      background: var(--panel);
      border-radius: 10px;
    }

    .leaflet-control-ndvi { background: rgba(30,41,59,.92); color:#e2e8f0; padding:10px 12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.35); font-size:12px; }
    .leaflet-control-ndvi h4{ margin:0 0 6px; font-size:13px; color:#60a5fa; }
    .leaflet-control-ndvi .bar { height:10px; width:180px; border-radius:6px; margin:6px 0; background: linear-gradient(90deg,#440154,#31688e,#35b779,#fde725); }
    .leaflet-control-ndvi .ticks{ display:flex; justify-content:space-between; opacity:.85; }

    .fiche-observatoire { position:absolute; top: 90px; right: 20px; width: 320px; background: var(--panel); padding: 14px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,.5); z-index: 2100; display:none; }
    .fiche-observatoire h3 { margin:0 0 8px; font-size:16px; color: var(--brand); }

    #modalChart { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,.85); z-index: 3000; justify-content:center; align-items:center; }
    #modalChart .card { position:relative; width:80%; max-width:1000px; }
    #modalChart .card button { position:absolute; top:10px; right:10px; background:#f87171; border:none; color:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; }

    #interfaceTraitement{
      display:none;
      position:fixed;
      top:70px;
      right:12px;
      width:320px;
      background:#fff;
      color:#111;
      border:1px solid #cbd5e1;
      border-radius:12px;
      padding:12px;
      z-index:2600;
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
    }

    @media (max-width: 768px){
      .main { flex-direction:column; height:auto; }
      .sidebar { width:100%; order:2; }
      .content { order:1; }
      #interfaceTraitement{ right:10px; left:10px; width:auto; }
      .map-overlays{ flex-wrap:wrap; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-left">
      <img src="logo-observatoire.png" alt="Logo GEO-SOVEREIGN" class="logo-flag" />
      <div class="logo-observatoire">
        <h1>GEO-SOVEREIGN</h1>
        <span class="subtitle">Observatoire Spatial National üáπüá© ‚Äî Focus Zakouma</span>
      </div>
    </div>
    <div class="header-right">
      <span class="status">üü¢ En ligne</span>
      <span class="date" id="currentDate"></span>
    </div>
  </header>

  <div class="main">
    <button id="toggleSidebarBtn" type="button">‚ò∞</button>

    <aside class="sidebar">
      <h2>Navigation par th√®me</h2>
      <div class="group">
        <select id="themeSelect" style="width:100%; padding:6px; border-radius:6px; background: var(--panel-2); color: var(--txt)">
          <option value="">‚Äî Choisir ‚Äî</option>
          <optgroup label="üåø V√©g√©tation"><option value="veg">NDVI / VCI / VHI</option></optgroup>
          <optgroup label="üíß Eau"><option value="eau">Hydrologie (JRC / Sentinel-1)</option></optgroup>
          <optgroup label="üêò Faune"><option value="faune">Corridors & Pistes</option></optgroup>
          <optgroup label="üî• Risques"><option value="risques">Feux & S√©cheresse</option></optgroup>
          <optgroup label="üèõÔ∏è Anthropique"><option value="anthro">Routes & Agriculture</option></optgroup>
          <optgroup label="üåø Aires prot√©g√©es"><option value="zakouma">Parc Zakouma</option></optgroup>
        </select>
      </div>

      <h2>üõ∞Ô∏è Imagerie & Indices</h2>
      <div class="group">
        <label><input type="checkbox" id="toggleBaseImagery" checked /> ESRI World Imagery</label>
        <label><input type="checkbox" id="toggleNDVI" checked /> NDVI (COG)</label>
        <label><input type="checkbox" id="toggleVCI" /> VCI</label>
        <label><input type="checkbox" id="toggleVHI" /> VHI</label>
        <label><input type="checkbox" id="toggleNDVICalc" /> NDVI (calcul√© B04/B08)</label>
        <label>
          <input type="checkbox" id="toggleGoogle3D" />
          üåç Google Photorealistic 3D
        </label>
      </div>

      <h2>üíß Hydrologie</h2>
      <div class="group">
        <label><input type="checkbox" id="toggleSoilMoisture" /> Humidit√© des sols</label>
        <label><input type="checkbox" id="toggleSurfaceWater" /> Eaux de surface (JRC)</label>
        <label><input type="checkbox" id="toggleFlood" /> Inondations (Sentinel-1)</label>
        <label><input type="checkbox" id="toggleWaterPoints" checked /> Points d‚Äôeau</label>
      </div>

      <h2>üêò Faune & Connectivit√©</h2>
      <div class="group">
        <label><input type="checkbox" id="toggleBoundary" checked /> Limite Zakouma</label>
        <label><input type="checkbox" id="toggleCorridors" /> Corridors √©cologiques</label>
        <label><input type="checkbox" id="toggleTracks" /> Pistes / Patrol</label>
      </div>

      <h2>üî• Risques climatiques</h2>
      <div class="group">
        <label><input type="checkbox" id="toggleFires" /> Feux actifs (FIRMS)</label>
        <div id="firesControls" style="margin-left:20px; display:none;">
          P√©riode :
          <select id="firesWindow">
            <option value="24">24 h</option><option value="48">48 h</option><option value="168">7 jours</option>
          </select>
        </div>
        <label><input type="checkbox" id="toggleSPI" /> SPI (s√©cheresse)</label>
        <label><input type="checkbox" id="toggleLST" /> Anomalies LST</label>
      </div>

      <h2>üèõÔ∏è Pressions anthropiques</h2>
      <div class="group">
        <label><input type="checkbox" id="toggleRoads" /> Routes OSM</label>
        <label><input type="checkbox" id="toggleAgri" /> Expansion agricole</label>
      </div>

      <div class="export-btn-container">
        <button type="button" id="btnExportPDF">üìÑ Exporter le rapport PDF</button>
      </div>
      <div style="margin-top:8px;">
        <button type="button" id="btnToggleTraitement">üß™ Traitement scientifique</button>
      </div>
    </aside>

    <div class="content">
      <div class="viewport">
        <div id="map"></div>
        <div id="cesiumContainer" style="display:none;"></div>

        <div class="map-overlays">
          <label><input type="checkbox" id="togglePointCloud" /> üåê Nuage de points (ion)</label>
          <label><input type="checkbox" id="toggleTerrainCustom" /> üóª Terrain (ion)</label>
          <label><input type="checkbox" id="toggleBuildings3D" /> üèôÔ∏è B√¢timents 3D (OSM)</label>
          <label><input type="checkbox" id="toggleTrees3D" /> üå≥ Arbres 3D (demo)</label>
        </div>

        <button id="btnToggle3DFixed" class="btn-float" type="button">üåç 2D / 3D</button>

        <!-- Fiche Observatoire -->
        <div id="ficheObservatoire" class="fiche-observatoire">
          <h3>Fiche Observatoire</h3>
          <div><b>Nom :</b> <span id="fiche-nom">‚Äî</span></div>
          <div><b>Type :</b> <span id="fiche-type">‚Äî</span></div>
          <div><b>Ann√©e :</b> <span id="fiche-annee">‚Äî</span></div>
          <div><b>Source :</b> <span id="fiche-source">‚Äî</span></div>
          <div><b>Statut :</b> <span id="fiche-statut">‚Äî</span></div>
          <button style="margin-top:10px;width:100%;" type="button"
                  onclick="document.getElementById('ficheObservatoire').style.display='none'">
            Fermer
          </button>
        </div>
      </div>

      <div class="bottom-row">
        <div class="filters-box">
          <h3>Filtrer par r√©gion</h3>
          <select id="filtreRegion">
            <option value="all">üåç Toutes les r√©gions</option>
            <option value="nord">Nord</option>
            <option value="sud">Sud</option>
            <option value="est">Est</option>
            <option value="ouest">Ouest</option>
          </select>

          <h3 style="margin-top:10px;">Filtres par ann√©e</h3>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button type="button" class="btnYear" data-year="2013">2013</button>
            <button type="button" class="btnYear" data-year="2019">2019</button>
            <button type="button" class="btnYear" data-year="2020">2020</button>
            <button type="button" class="btnYear" data-year="2022">2022</button>
            <button type="button" id="btnResetChart">R√©initialiser</button>
          </div>
        </div>

        <div class="dashboard-boxes">
          <div class="dashboard-box"><div class="percentage"><span id="val-stress">55</span>%</div><div class="label">Stress hydrique</div></div>
          <div class="dashboard-box"><div class="percentage"><span id="val-foret">67</span>%</div><div class="label">Couverture foresti√®re</div></div>
          <div class="dashboard-box"><div class="percentage"><span id="val-urbain">32</span>%</div><div class="label">Croissance urbaine</div></div>
        </div>

        <div class="chart-box" style="display:flex; flex-direction:column;">
          <canvas id="lineChart"></canvas>
          <button type="button" id="btnZoomChart" style="margin-top:10px; align-self:flex-end;">üîé Voir en grand</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau Traitement -->
  <div id="interfaceTraitement">
    <h3 style="margin:0 0 10px;">Traitement scientifique</h3>
    <label for="typeRendu"><b>Choisir un rendu :</b></label>
    <select id="typeRendu" style="width:100%; margin-top:8px;">
      <option value="ndvi">üåø NDVI</option>
      <option value="pente">üß≠ Pente</option>
      <option value="exposition">üß≠ Exposition</option>
      <option value="ombrage">‚òÄÔ∏è Ombrage</option>
    </select>
    <p style="margin:10px 0 0; font-size:12px; color:#334155;">
      Conseil d√©mo : NDVI + pente + ombrage impressionnent bien en pr√©sentation.
    </p>
  </div>

  <!-- Modal graphique -->
  <div id="modalChart">
    <div class="card">
      <button type="button" onclick="fermerGraphiqueZoom()">‚úñ</button>
      <div class="chart-box" style="padding:12px;">
        <canvas id="lineChartZoom"></canvas>
      </div>
    </div>
  </div>

  <div id="infosGeoTechCompact">GEO-SOVEREIGN ¬∑ Zakouma</div>

  <script>
    /* ===========================
       CONFIG (placeholders)
    ============================ */
    window.ENABLE_GOOGLE_3D = true;
    window.GOOGLE_MAPS_API_KEY = ""; // <-- mets ta cl√© localement si besoin (localhost seulement)
    window.SAFE_HOSTS = new Set(["localhost","127.0.0.1"]);

    const ION_TOKEN = ""; // <-- mets ton token Cesium ion localement
    if (ION_TOKEN) Cesium.Ion.defaultAccessToken = ION_TOKEN;

    /* ===========================
       CONSTANTES & DATA PATHS
    ============================ */
    const ZAKOUMA_CENTER = [10.97, 19.90];
    const ZAKOUMA_ZOOM   = 9;
    const ZAKOUMA_BOUNDS = [[10.6,19.3],[11.3,20.2]];

    // Raster
    const NDVI_COG_URL = "data/zakouma_ndvi_cog.tif";      // NDVI pr√™t (COG / GeoTIFF)
    const DEM_MNT_URL  = "data/zakouma_dem_mnt.tif";       // DEM (MNT)
    const S2_B04_COG_URL = "data/S2_B04_cog.tif";          // rouge
    const S2_B08_COG_URL = "data/S2_B08_cog.tif";          // nir

    /* ===========================
       DEV BANNER + DATE
    ============================ */
    function setDateHeader(){
      const e = document.getElementById("currentDate");
      if(!e) return;
      const now = new Date();
      e.textContent = now.toLocaleDateString("fr-FR", {weekday:"long",year:"numeric",month:"long",day:"numeric"});
    }

    /* ===========================
       WAIT LIBS (GeoTIFF/GeoRaster)
    ============================ */
    async function waitForLibs(){
      const hasGeoTIFF = () => !!(window.GeoTIFF || window.geotiff);
      const hasGeoRaster = () => !!(window.parseGeoraster || (window.georaster && window.georaster.parse));
      const hasGeoRasterLayer = () => !!(window.GeoRasterLayer || (window.L && window.L.GeoRasterLayer));
      const deadline = Date.now() + 10000;

      while(true){
        if (hasGeoTIFF() && hasGeoRaster() && hasGeoRasterLayer()) return;
        if (Date.now() > deadline){
          console.error("[timeout] GeoTIFF:", hasGeoTIFF(), "GeoRaster:", hasGeoRaster(), "GeoRasterLayer:", hasGeoRasterLayer());
          throw new Error("Libs GeoTIFF/GeoRaster non charg√©es");
        }
        await new Promise(r => setTimeout(r, 50));
      }
    }

    async function safeFetchJson(path){
      try{
        if (location.protocol === "file:") return null;
        const r = await fetch(path, { cache:"no-store" });
        if(!r.ok) throw new Error("HTTP "+r.status);
        return await r.json();
      }catch(_){
        return null;
      }
    }

    async function fetchArrayBuffer(url){
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status} sur ${url}`);
      return await r.arrayBuffer();
    }
    async function parseGeorasterFromUrl(url){
      const buf = await fetchArrayBuffer(url);
      return await parseGeoraster(buf);
    }

    /* ===========================
       MAP LEAFLET
    ============================ */
    const map = L.map("map", { center: ZAKOUMA_CENTER, zoom: ZAKOUMA_ZOOM, worldCopyJump:true });

    const esriImagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution:"¬© Esri", noWrap:true }
    ).addTo(map);

    requestAnimationFrame(() => map.invalidateSize());
    setTimeout(() => map.invalidateSize(), 250);
    window.addEventListener("resize", () => map.invalidateSize());

    function stylePolyline(color="#22d3ee", weight=2){ return { color, weight }; }
    function stylePolygon(color="#22c55e", weight=1, fillOpacity=0.25){ return { color, weight, fillOpacity }; }
    function pointCircle(color="#0ea5e9", radius=6){ return { radius, color, fillOpacity:.85 }; }

    /* ===========================
       DEMO FALLBACKS
    ============================ */
    const DEMO_BOUNDARY = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Parc national de Zakouma","source":"GEO-SOV","year":2024,"type":"Aire prot√©g√©e","statut":"D√©mo"},"geometry":{"type":"Polygon","coordinates":[[[19.35,10.7],[20.1,10.7],[20.1,11.25],[19.35,11.25],[19.35,10.7]]]}}]};
    const DEMO_WATERPTS = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Mare Fada","type":"Mare","source":"D√©mo","statut":"Actif"},"geometry":{"type":"Point","coordinates":[19.85,10.95]}},{"type":"Feature","properties":{"name":"Forage Kach","type":"Forage","source":"D√©mo","statut":"Actif"},"geometry":{"type":"Point","coordinates":[19.62,11.10]}}]};
    const DEMO_TRACKS   = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Patrol Nord","type":"Piste"},"geometry":{"type":"LineString","coordinates":[[19.5,11.2],[19.8,11.1],[19.95,11.0]]}},{"type":"Feature","properties":{"name":"Patrol Sud","type":"Piste"},"geometry":{"type":"LineString","coordinates":[[19.4,10.8],[19.6,10.9],[19.9,10.9]]}}]};
    const DEMO_CORRID   = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Corridor Nord-Est","type":"Corridor"},"geometry":{"type":"LineString","coordinates":[[19.8,11.1],[20.2,11.3]]}}]};
    const DEMO_NDVI_CHG = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"ndvi_change":"hausse","valeur_diff":0.27,"name":"Zone NDVI","type":"Analyse"},"geometry":{"type":"Polygon","coordinates":[[[19.5,11.0],[19.7,11.0],[19.7,11.2],[19.5,11.2],[19.5,11.0]]]}}]};

    /* ===========================
       LAYERS
    ============================ */
    const LAYERS = {
      boundary:null, waterPoints:null, tracks:null, corridors:null,
      ndviVector:null, ndviCog:null, vci:null, vhi:null,
      soilMoisture:null, surfaceWater:null, flood:null,
      fires:null, spi:null, lst:null,
      roads:null, agri:null,
      ndviCalc:null, demProduct:null
    };

    /* ===========================
       NDVI COLORS + LEGEND
    ============================ */
    let ndviLegendControl = null;

    function getNdviColor(t){
      const stops=[{p:0.00,c:[0x44,0x01,0x54]},{p:0.33,c:[0x31,0x68,0x8e]},{p:0.66,c:[0x35,0xb7,0x79]},{p:1.00,c:[0xfd,0xe7,0x25]}];
      for (let i=0;i<stops.length-1;i++){
        const a=stops[i], b=stops[i+1];
        if (t>=a.p && t<=b.p){
          const u=(t-a.p)/(b.p-a.p);
          const r=Math.round(a.c[0]+u*(b.c[0]-a.c[0]));
          const g=Math.round(a.c[1]+u*(b.c[1]-a.c[1]));
          const bb=Math.round(a.c[2]+u*(b.c[2]-a.c[2]));
          return `rgb(${r},${g},${bb})`;
        }
      }
      const last=stops[stops.length-1].c; return `rgb(${last[0]},${last[1]},${last[2]})`;
    }

    function ensureNdviLegend(){
      if (ndviLegendControl) return;
      ndviLegendControl = L.control({ position:"bottomright" });
      ndviLegendControl.onAdd = function(){
        const div = L.DomUtil.create("div","leaflet-control-ndvi");
        div.innerHTML = `<h4>NDVI</h4><div class="bar"></div><div class="ticks"><span>-1.0</span><span>0.0</span><span>+1.0</span></div>`;
        return div;
      };
      ndviLegendControl.addTo(map);
    }

    function removeNdviLegend(){
      if (ndviLegendControl){
        ndviLegendControl.remove();
        ndviLegendControl = null;
      }
    }

    /* ===========================
       HELPERS GEOJSON
    ============================ */
    function addGeoJson(obj, opts={}){ return L.geoJSON(obj, opts).addTo(map); }

    async function loadGeoJson(path, fallback, opts={}){
      const data = await safeFetchJson(path);
      return addGeoJson(data || fallback, opts);
    }

    function afficherFicheObservatoire(feature){
      const p = feature?.properties || {};
      document.getElementById("fiche-nom").textContent = p.name || "‚Äî";
      document.getElementById("fiche-type").textContent = p.type || "‚Äî";
      document.getElementById("fiche-annee").textContent = p.year || p.annee || "‚Äî";
      document.getElementById("fiche-source").textContent = p.source || "‚Äî";
      document.getElementById("fiche-statut").textContent = p.statut || "‚Äî";
      document.getElementById("ficheObservatoire").style.display = "block";
    }

    /* ===========================
       TOGGLES LEAFLET
    ============================ */
    async function toggleBoundary(on=true){
      if (on && !LAYERS.boundary){
        LAYERS.boundary = await loadGeoJson("data/zakouma_boundary.geojson", DEMO_BOUNDARY, {
          style: stylePolygon("#60a5fa",2,0.08),
          onEachFeature:(f,l)=>{
            l.bindPopup(`<b>${f.properties?.name||"Zakouma"}</b><br/>Clique pour fiche`);
            l.on("click", ()=> afficherFicheObservatoire(f));
          }
        });
      }
      if (!on && LAYERS.boundary){ map.removeLayer(LAYERS.boundary); LAYERS.boundary=null; }
    }

    async function toggleWaterPoints(on=true){
      if (on && !LAYERS.waterPoints){
        LAYERS.waterPoints = await loadGeoJson("data/zakouma_water.geojson", DEMO_WATERPTS, {
          pointToLayer:(f,latlng)=>L.circleMarker(latlng, pointCircle("#22d3ee",7)),
          onEachFeature:(f,l)=>{
            l.bindPopup(`üíß <b>${f.properties?.name||"Point d‚Äôeau"}</b><br/>Clique pour fiche`);
            l.on("click", ()=> afficherFicheObservatoire(f));
          }
        });
      }
      if (!on && LAYERS.waterPoints){ map.removeLayer(LAYERS.waterPoints); LAYERS.waterPoints=null; }
    }

    async function toggleCorridors(on=true){
      if (on && !LAYERS.corridors){
        LAYERS.corridors = await loadGeoJson("data/zakouma_corridors.geojson", DEMO_CORRID, {
          style: stylePolyline("#10b981",3),
          onEachFeature:(f,l)=> l.bindPopup(`üß≠ Corridor: ${f.properties?.name||"‚Äî"}`)
        });
      }
      if (!on && LAYERS.corridors){ map.removeLayer(LAYERS.corridors); LAYERS.corridors=null; }
    }

    async function toggleTracks(on=true){
      if (on && !LAYERS.tracks){
        LAYERS.tracks = await loadGeoJson("data/zakouma_tracks.geojson", DEMO_TRACKS, {
          style: stylePolyline("#f59e0b",2),
          onEachFeature:(f,l)=> l.bindPopup(`üõ£Ô∏è ${f.properties?.name||"Piste"}`)
        });
      }
      if (!on && LAYERS.tracks){ map.removeLayer(LAYERS.tracks); LAYERS.tracks=null; }
    }

    async function toggleNDVI(on=true){
      if (on){
        if (!LAYERS.ndviVector){
          LAYERS.ndviVector = await loadGeoJson("data/zakouma_ndvi_change.geojson", DEMO_NDVI_CHG, {
            style: (feat)=>{
              const ch=feat.properties?.ndvi_change;
              if (ch==="hausse") return { color: getNdviColor(.75), weight:2, fillOpacity:.25 };
              if (ch==="baisse") return { color: getNdviColor(.15), weight:2, fillOpacity:.25 };
              return { color: getNdviColor(.35), weight:1, fillOpacity:.15 };
            },
            onEachFeature:(f,l)=> l.bindPopup(`üìä ŒîNDVI: ${(Number(f.properties?.valeur_diff)||0).toFixed(2)} (${f.properties?.ndvi_change||"‚Äî"})`)
          });
        }

        if (!LAYERS.ndviCog && NDVI_COG_URL){
          try{
            const georaster = await parseGeorasterFromUrl(NDVI_COG_URL);
            LAYERS.ndviCog = new GeoRasterLayer({
              georaster,
              resolution: 256,
              opacity: .75,
              pixelValuesToColorFn: (values)=>{
                const v = values?.[0];
                if (v === undefined || v === null || isNaN(v)) return null;
                const t = Math.max(0, Math.min(1, (v + 1) / 2));
                return getNdviColor(t);
              }
            }).addTo(map);
          }catch(e){
            console.warn("NDVI COG non charg√©:", e);
          }
        }

        ensureNdviLegend();
      } else {
        if (LAYERS.ndviVector){ map.removeLayer(LAYERS.ndviVector); LAYERS.ndviVector=null; }
        if (LAYERS.ndviCog){ map.removeLayer(LAYERS.ndviCog); LAYERS.ndviCog=null; }
        if(!LAYERS.ndviCalc) removeNdviLegend();
      }
    }

    function makeGenericTile(urlTemplate, attribution=""){ return L.tileLayer(urlTemplate, { attribution, opacity:.75 }); }
    async function toggleVCI(on=true){
      if (on && !LAYERS.vci){ LAYERS.vci = makeGenericTile("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","Demo VCI"); LAYERS.vci.setOpacity(0.0); LAYERS.vci.addTo(map); }
      if (!on && LAYERS.vci){ map.removeLayer(LAYERS.vci); LAYERS.vci=null; }
    }
    async function toggleVHI(on=true){
      if (on && !LAYERS.vhi){ LAYERS.vhi = makeGenericTile("https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png","Demo VHI"); LAYERS.vhi.setOpacity(0.0); LAYERS.vhi.addTo(map); }
      if (!on && LAYERS.vhi){ map.removeLayer(LAYERS.vhi); LAYERS.vhi=null; }
    }

    async function toggleSoilMoisture(on=true){
      if (on && !LAYERS.soilMoisture){ LAYERS.soilMoisture = makeGenericTile("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png","Demo Soil Moisture"); LAYERS.soilMoisture.setOpacity(0.0); LAYERS.soilMoisture.addTo(map); }
      if (!on && LAYERS.soilMoisture){ map.removeLayer(LAYERS.soilMoisture); LAYERS.soilMoisture=null; }
    }
    async function toggleSurfaceWater(on=true){
      if (on && !LAYERS.surfaceWater){ LAYERS.surfaceWater = makeGenericTile("https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png","Demo Surface Water"); LAYERS.surfaceWater.setOpacity(0.0); LAYERS.surfaceWater.addTo(map); }
      if (!on && LAYERS.surfaceWater){ map.removeLayer(LAYERS.surfaceWater); LAYERS.surfaceWater=null; }
    }
    async function toggleFlood(on=true){
      if (on && !LAYERS.flood){ LAYERS.flood = makeGenericTile("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","Demo Flood"); LAYERS.flood.setOpacity(0.0); LAYERS.flood.addTo(map); }
      if (!on && LAYERS.flood){ map.removeLayer(LAYERS.flood); LAYERS.flood=null; }
    }

    async function toggleFires(on=true){
      const controls = document.getElementById("firesControls");
      if (controls) controls.style.display = on ? "block" : "none";
      if (on && !LAYERS.fires){ LAYERS.fires = addGeoJson({"type":"FeatureCollection","features":[]}); }
      if (!on && LAYERS.fires){ map.removeLayer(LAYERS.fires); LAYERS.fires=null; }
    }
    async function toggleSPI(on=true){
      if (on && !LAYERS.spi){ LAYERS.spi = makeGenericTile("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png","Demo SPI"); LAYERS.spi.setOpacity(0.0); LAYERS.spi.addTo(map); }
      if (!on && LAYERS.spi){ map.removeLayer(LAYERS.spi); LAYERS.spi=null; }
    }
    async function toggleLST(on=true){
      if (on && !LAYERS.lst){ LAYERS.lst = makeGenericTile("https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png","Demo LST"); LAYERS.lst.setOpacity(0.0); LAYERS.lst.addTo(map); }
      if (!on && LAYERS.lst){ map.removeLayer(LAYERS.lst); LAYERS.lst=null; }
    }

    async function toggleRoads(on=true){
      if (on && !LAYERS.roads){
        LAYERS.roads = await loadGeoJson("data/roads.geojson", {"type":"FeatureCollection","features":[]}, { style: stylePolyline("#94a3b8",1) });
      }
      if (!on && LAYERS.roads){ map.removeLayer(LAYERS.roads); LAYERS.roads=null; }
    }

    async function toggleAgri(on=true){
      if (on && !LAYERS.agri){
        const fallback = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"year":"2023","change":"+23 ha"},"geometry":{"type":"Polygon","coordinates":[[[19.55,10.92],[19.66,10.92],[19.66,10.84],[19.55,10.84],[19.55,10.92]]]}}]};
        LAYERS.agri = await loadGeoJson("data/agri_change.geojson", fallback, {
          style: stylePolygon("#f43f5e",1.5,0.20),
          onEachFeature:(f,l)=> l.bindPopup(`üåæ Changement agricole: ${f.properties?.change||"‚Äî"} (${f.properties?.year||""})`)
        });
      }
      if (!on && LAYERS.agri){ map.removeLayer(LAYERS.agri); LAYERS.agri=null; }
    }

    /* ===========================
       NDVI CALC B04/B08
    ============================ */
    async function toggleNDVICalc(on=true){
      if (on && !LAYERS.ndviCalc){
        try{
          const [rRed, rNir] = await Promise.all([
            parseGeorasterFromUrl(S2_B04_COG_URL),
            parseGeorasterFromUrl(S2_B08_COG_URL),
          ]);

          LAYERS.ndviCalc = new GeoRasterLayer({
            georasters: [rRed, rNir],
            resolution: 256,
            opacity: .75,
            pixelValuesToColorFn: (vals) => {
              const red = vals?.[0];
              const nir = vals?.[1];
              if (red == null || nir == null || isNaN(red) || isNaN(nir)) return null;
              const s = nir + red;
              if (s === 0) return null;
              const ndvi = (nir - red) / s;
              const t = Math.max(0, Math.min(1, (ndvi + 1) / 2));
              return getNdviColor(t);
            }
          }).addTo(map);

          ensureNdviLegend();
        }catch(e){
          console.warn("NDVI calcul√© (B04/B08) non charg√©:", e);
          alert("Impossible de calculer NDVI (B04/B08). V√©rifie les fichiers data/S2_B04_cog.tif et data/S2_B08_cog.tif");
        }
      }

      if (!on && LAYERS.ndviCalc){
        map.removeLayer(LAYERS.ndviCalc);
        LAYERS.ndviCalc = null;
        const ndviAny = LAYERS.ndviVector || LAYERS.ndviCog || LAYERS.ndviCalc;
        if (!ndviAny) removeNdviLegend();
      }
    }

    /* ===========================
       DEM PRODUCTS (pente/aspect/ombrage)
    ============================ */
    function hsvToRgb(h,s,v){
      const i=Math.floor(h*6), f=h*6-i, p=v*(1-s), q=v*(1-f*s), t=v*(1-(1-f)*s);
      let r=0,g=0,b=0;
      switch(i%6){
        case 0:r=v;g=t;b=p;break;
        case 1:r=q;g=v;b=p;break;
        case 2:r=p;g=v;b=t;break;
        case 3:r=p;g=q;b=v;break;
        case 4:r=t;g=p;b=v;break;
        case 5:r=v;g=p;b=q;break;
      }
      return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];
    }

    async function renderDemProduct(product="pente"){
      try{
        const gr = await parseGeorasterFromUrl(DEM_MNT_URL);
        const arr = gr.values ? gr.values[0] : (gr.rasters ? gr.rasters[0] : gr.data[0]);
        const width = gr.width || gr.cols || gr.columns;
        const height = gr.height || gr.rows;
        const xmin=gr.xmin, xmax=gr.xmax, ymin=gr.ymin, ymax=gr.ymax;

        const cellX = Math.abs(gr.pixelWidth || (xmax-xmin)/width);
        const cellY = Math.abs(gr.pixelHeight || (ymax-ymin)/height);

        const maxW=1024;
        const scale = Math.max(1, Math.ceil(width/maxW));
        const outW = Math.floor(width/scale);
        const outH = Math.floor(height/scale);

        const canvas = document.createElement("canvas");
        canvas.width = outW;
        canvas.height = outH;
        const ctx = canvas.getContext("2d");
        const img = ctx.createImageData(outW, outH);

        const sunAz=315*Math.PI/180, sunAlt=45*Math.PI/180;
        const idx=(x,y)=>y*width+x;
        let p=0;

        for(let y=1;y<height-1;y+=scale){
          for(let x=1;x<width-1;x+=scale){
            const z1=arr[idx(x-1,y-1)], z2=arr[idx(x,y-1)], z3=arr[idx(x+1,y-1)];
            const z4=arr[idx(x-1,y)],   z6=arr[idx(x+1,y)];
            const z7=arr[idx(x-1,y+1)], z8=arr[idx(x,y+1)], z9=arr[idx(x+1,y+1)];

            const dzdx=((z3+2*z6+z9)-(z1+2*z4+z7))/(8*cellX);
            const dzdy=((z7+2*z8+z9)-(z1+2*z2+z3))/(8*cellY);

            const slope = Math.atan(Math.hypot(dzdx,dzdy));
            const aspect = Math.atan2(dzdy,-dzdx);

            let R=0,G=0,B=0,A=255;
            if(product==="pente"){
              const t = Math.max(0, Math.min(1, (slope*180/Math.PI)/60));
              const v = Math.round(255*t);
              R=G=B=v; A=220;
            } else if(product==="exposition"){
              let asp=aspect; if(asp<0) asp+=2*Math.PI;
              const h=asp/(2*Math.PI);
              const rgb=hsvToRgb(h,1,1);
              R=rgb[0]; G=rgb[1]; B=rgb[2]; A=220;
            } else { // ombrage
              const hs = 255*(Math.cos(sunAlt)*Math.cos(slope) + Math.sin(sunAlt)*Math.sin(slope)*Math.cos(sunAz-aspect));
              const v = Math.max(0, Math.min(255, Math.round(hs)));
              R=G=B=v; A=255;
            }

            img.data[p++]=R; img.data[p++]=G; img.data[p++]=B; img.data[p++]=A;
          }
        }
        ctx.putImageData(img,0,0);

        const bounds = [[ymin,xmin],[ymax,xmax]];

        if (LAYERS.demProduct){
          map.removeLayer(LAYERS.demProduct);
          LAYERS.demProduct = null;
        }
        LAYERS.demProduct = L.imageOverlay(canvas.toDataURL(), bounds, {opacity:.85}).addTo(map);

      }catch(e){
        console.error("DEM produit non g√©n√©r√©:", e);
        alert("DEM introuvable ou illisible. V√©rifie data/zakouma_dem_mnt.tif");
      }
    }

    /* ===========================
       THEMES
    ============================ */
    async function changerTheme(value){
      if (!value) return;
      map.fitBounds(ZAKOUMA_BOUNDS, { padding:[20,20] });

      if (value==="zakouma"){ await toggleBoundary(true); await toggleWaterPoints(true); await toggleNDVI(true); }
      if (value==="veg"){ await toggleNDVI(true); await toggleVCI(true); await toggleVHI(true); await toggleBoundary(true); }
      if (value==="eau"){ await toggleSurfaceWater(true); await toggleSoilMoisture(true); await toggleFlood(true); await toggleWaterPoints(true); await toggleBoundary(true); }
      if (value==="faune"){ await toggleBoundary(true); await toggleCorridors(true); await toggleTracks(true); }
      if (value==="risques"){ await toggleBoundary(true); await toggleFires(true); await toggleSPI(true); await toggleLST(true); }
      if (value==="anthro"){ await toggleBoundary(true); await toggleRoads(true); await toggleAgri(true); }
    }

    function filtrerParRegion(region){
      const views = { all:[10.97,19.90,9], nord:[11.2,19.9,9], sud:[10.7,19.9,9], est:[10.97,20.1,9], ouest:[10.97,19.6,9] };
      const v = views[region] || views.all;
      map.setView([v[0],v[1]], v[2]);
    }

    /* ===========================
       CHART + DASH
    ============================ */
    window.indicateursData = {
      "2013": { stress:43, foret:62, urbain:25 },
      "2019": { stress:50, foret:65, urbain:28 },
      "2020": { stress:52, foret:66, urbain:30 },
      "2022": { stress:55, foret:67, urbain:32 },
      "all":  { stress:55, foret:67, urbain:32 }
    };

    function genererGaussienne(mu, sigma, n=120){
      const data=[], labels=[];
      const min = mu-4*sigma, max = mu+4*sigma;
      const pas = (max-min)/n;
      for(let x=min; x<=max; x+=pas){
        const y = (1/(sigma*Math.sqrt(2*Math.PI))) * Math.exp(-0.5 * ((x-mu)/sigma)**2);
        labels.push(x.toFixed(2));
        data.push(y);
      }
      return { labels, data };
    }

    let chart = null;
    let chartZoom = null;

    function initChart(){
      const canvas = document.getElementById("lineChart");
      const ctx = canvas.getContext("2d");
      const gauss = genererGaussienne(0,1,120);

      chart = new Chart(ctx, {
        type:"line",
        data:{
          labels: ["2013","2019","2020","2022"],
          datasets:[
            { label:"üåæ Terres cultiv√©es", data:[50,60,70,80], borderColor:"#38bdf8", backgroundColor:"rgba(56,189,248,.35)", tension:.4, fill:true },
            { label:"üî• S√©cheresses", data:[20,30,40,55], borderColor:"#f87171", backgroundColor:"rgba(248,113,113,.35)", tension:.4, fill:true },
            { label:"üë• Population", data:[30,35,40,50], borderColor:"#c084fc", backgroundColor:"rgba(192,132,252,.35)", tension:.4, fill:true },
            { label:"üìä Distribution Gaussienne", data: gauss.data, borderColor:"#34d399", backgroundColor:"rgba(52,211,153,.3)", tension:.4, fill:true, pointRadius:0 }
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:"#e2e8f0", font:{ size:14 } } } },
          scales:{
            x:{ ticks:{ color:"#e2e8f0" }, grid:{ color:"rgba(255,255,255,.1)" } },
            y:{ ticks:{ color:"#e2e8f0" }, grid:{ color:"rgba(255,255,255,.1)" } }
          }
        }
      });
    }

    function applyIndicators(year){
      const info = window.indicateursData[year] || window.indicateursData["all"];
      document.getElementById("val-stress").textContent = info.stress;
      document.getElementById("val-foret").textContent  = info.foret;
      document.getElementById("val-urbain").textContent = info.urbain;
    }

    function filterByYear(year, buttonEl){
      if(!chart) return;
      const labels = ["2013","2019","2020","2022"];
      const idx = labels.indexOf(year);
      if(idx === -1) return;

      const d = chart.data;
      d.labels = [year];

      d.datasets[0].data = [ [50,60,70,80][idx] ];
      d.datasets[1].data = [ [20,30,40,55][idx] ];
      d.datasets[2].data = [ [30,35,40,50][idx] ];

      chart.update();
      applyIndicators(year);

      document.querySelectorAll(".btnYear").forEach(b => b.classList.remove("active"));
      if(buttonEl) buttonEl.classList.add("active");
    }

    function resetChart(){
      if(!chart) return;
      chart.data.labels = ["2013","2019","2020","2022"];
      chart.data.datasets[0].data = [50,60,70,80];
      chart.data.datasets[1].data = [20,30,40,55];
      chart.data.datasets[2].data = [30,35,40,50];
      chart.update();
      applyIndicators("all");
      document.querySelectorAll(".btnYear").forEach(b => b.classList.remove("active"));
    }

    function ouvrirGraphiqueZoom(){
      const modal = document.getElementById("modalChart");
      modal.style.display = "flex";

      const ctxZ = document.getElementById("lineChartZoom").getContext("2d");
      if(chartZoom) chartZoom.destroy();

      chartZoom = new Chart(ctxZ, {
        type:"line",
        data: JSON.parse(JSON.stringify(chart.data)),
        options: chart.options
      });
    }

    function fermerGraphiqueZoom(){
      const modal = document.getElementById("modalChart");
      modal.style.display = "none";
      if(chartZoom){ chartZoom.destroy(); chartZoom = null; }
    }

    /* ===========================
       EXPORT PDF
    ============================ */
    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(18);
      pdf.text("Rapport GEO-SOVEREIGN ‚Äî Zakouma", 20, 20);

      pdf.setFontSize(12);
      pdf.text(`Date : ${new Date().toLocaleDateString("fr-FR")}`, 20, 30);
      pdf.text(`üìä Stress hydrique : ${document.getElementById("val-stress").textContent}%`, 20, 40);
      pdf.text(`üå≤ Couverture foresti√®re : ${document.getElementById("val-foret").textContent}%`, 20, 50);
      pdf.text(`üèôÔ∏è Croissance urbaine : ${document.getElementById("val-urbain").textContent}%`, 20, 60);

      const canvas = document.getElementById("lineChart");
      const imageData = canvas.toDataURL("image/png", 1.0);
      pdf.addImage(imageData, "PNG", 15, 75, 180, 80);

      pdf.save("rapport_GEO-SOVEREIGN_Zakouma.pdf");
    }

    /* ===========================
       CESIUM 3D
    ============================ */
    let viewerCesium = null;
    let cesiumActive = false;

    const layersCesium = {
      pointCloud: null,
      terrainCustom: null,
      buildingsOSM: null,
      treesDemo: null,
      google3DTiles: null
    };

    // D√©mo ion
    const ION_POINTCLOUD_ASSET_ID = 96188;
    const ION_TERRAIN_ASSET_ID = 1;

    function ensureCesium(){
      if(viewerCesium) return viewerCesium;

      viewerCesium = new Cesium.Viewer("cesiumContainer", {
        imageryProvider: undefined,
        terrainProvider: Cesium.Terrain.fromWorldTerrain({
          requestVertexNormals: true,
          requestWaterMask: true
        }),
        baseLayerPicker: false,
        animation: false,
        timeline: false
      });

      viewerCesium.imageryLayers.addImageryProvider(
        new Cesium.UrlTemplateImageryProvider({
          url: "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
          credit: "¬© OpenStreetMap"
        })
      );

      viewerCesium.scene.globe.enableLighting = true;
      viewerCesium.shadowMap.enabled = true;
      viewerCesium.shadowMap.softShadows = true;
      viewerCesium.scene.globe.depthTestAgainstTerrain = true;

      viewerCesium.scene.verticalExaggeration = 1.3;
      viewerCesium.scene.verticalExaggerationRelativeHeight = 0;

      viewerCesium.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(19.9, 10.97, 800000)
      });

      viewerCesium.scene.requestRender();
      return viewerCesium;
    }

    function toggleCesium(){
      const cesiumDiv  = document.getElementById("cesiumContainer");
      const leafletDiv = document.getElementById("map");

      if(!cesiumActive){
        ensureCesium();
        leafletDiv.style.display = "none";
        cesiumDiv.style.display = "block";
        try{ viewerCesium.resize(); }catch(_){}
        viewerCesium.scene.requestRender?.();
        cesiumActive = true;
        const btn = document.getElementById("btnToggle3DFixed");
        if(btn) btn.textContent = "‚Ü©Ô∏è Revenir en 2D";
      } else {
        cesiumDiv.style.display = "none";
        leafletDiv.style.display = "block";
        requestAnimationFrame(() => {
          map.invalidateSize();
          setTimeout(() => map.invalidateSize(), 120);
        });
        cesiumActive = false;
        const btn = document.getElementById("btnToggle3DFixed");
        if(btn) btn.textContent = "üåç 2D / 3D";
      }
    }

    async function togglePointCloudCesium(on=true){
      if(!on){
        if(layersCesium.pointCloud && viewerCesium){
          viewerCesium.scene.primitives.remove(layersCesium.pointCloud);
          layersCesium.pointCloud=null;
          viewerCesium.scene.requestRender?.();
        }
        return;
      }
      if(!viewerCesium) ensureCesium();
      if(layersCesium.pointCloud) return;

      try{
        const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(ION_POINTCLOUD_ASSET_ID);
        layersCesium.pointCloud = viewerCesium.scene.primitives.add(tileset);
        await tileset.readyPromise;

        if(tileset.pointCloudShading){
          tileset.pointCloudShading.attenuation = true;
          tileset.pointCloudShading.eyeDomeLighting = true;
        }
        viewerCesium.zoomTo(tileset);
        viewerCesium.scene.requestRender?.();
      }catch(e){
        console.error("Point cloud ion:", e);
        const cb = document.getElementById("togglePointCloud");
        if(cb) cb.checked=false;
        alert("√âchec chargement nuage de points (ion).");
      }
    }

    async function toggleTerrainCesium(on=true){
      if(!viewerCesium) ensureCesium();
      try{
        if(on && !layersCesium.terrainCustom){
          layersCesium.terrainCustom = await Cesium.CesiumTerrainProvider.fromIonAssetId(ION_TERRAIN_ASSET_ID);
          viewerCesium.terrainProvider = layersCesium.terrainCustom;
        }
        if(!on && layersCesium.terrainCustom){
          viewerCesium.terrainProvider = Cesium.Terrain.fromWorldTerrain();
          layersCesium.terrainCustom=null;
        }
        viewerCesium.scene.requestRender?.();
      }catch(e){
        console.error("Terrain ion:", e);
        const cb = document.getElementById("toggleTerrainCustom");
        if(cb) cb.checked=false;
        alert("√âchec chargement terrain (ion).");
      }
    }

    async function toggleBuildings3D(on=true){
      if(!viewerCesium) ensureCesium();
      if(on){
        if(layersCesium.buildingsOSM) return;
        try{
          const tileset = await Cesium.createOsmBuildingsAsync();
          layersCesium.buildingsOSM = viewerCesium.scene.primitives.add(tileset);
          viewerCesium.scene.requestRender?.();
        }catch(e){
          console.error("OSM Buildings:", e);
          const cb = document.getElementById("toggleBuildings3D");
          if(cb) cb.checked=false;
          alert("Impossible de charger les b√¢timents OSM.");
        }
      }else{
        if(layersCesium.buildingsOSM){
          viewerCesium.scene.primitives.remove(layersCesium.buildingsOSM);
          layersCesium.buildingsOSM=null;
          viewerCesium.scene.requestRender?.();
        }
      }
    }

    async function toggleTrees3D(on=true){
      if(!viewerCesium) ensureCesium();
      if(on){
        if(layersCesium.treesDemo) return;
        const collection = new Cesium.BillboardCollection();
        layersCesium.treesDemo = collection;
        viewerCesium.scene.primitives.add(collection);

        const pts = [[19.82,10.98],[19.84,10.99],[19.86,10.97],[19.88,11.00],[19.90,10.96]];
        const img = "https://cdn.jsdelivr.net/gh/epistemic-polymath/assets@main/icons/tree_round.png";
        for(const [lon,lat] of pts){
          collection.add({ position: Cesium.Cartesian3.fromDegrees(lon,lat,0), image: img, scale: 1.2 });
        }
        viewerCesium.scene.requestRender?.();
      }else{
        if(layersCesium.treesDemo){
          viewerCesium.scene.primitives.remove(layersCesium.treesDemo);
          layersCesium.treesDemo=null;
          viewerCesium.scene.requestRender?.();
        }
      }
    }

    async function toggleGoogle3DTiles(on=true){
      const chk = document.getElementById("toggleGoogle3D");

      if(!on){
        if(layersCesium.google3DTiles && viewerCesium){
          viewerCesium.scene.primitives.remove(layersCesium.google3DTiles);
          layersCesium.google3DTiles=null;
          viewerCesium.scene.requestRender?.();
        }
        return;
      }

      if(!window.ENABLE_GOOGLE_3D){
        alert("Google 3D est d√©sactiv√© (ENABLE_GOOGLE_3D=false).");
        if(chk) chk.checked=false;
        return;
      }
      if(!window.SAFE_HOSTS.has(location.hostname)){
        alert("Google 3D autoris√© seulement en local (localhost).");
        if(chk) chk.checked=false;
        return;
      }
      if(!window.GOOGLE_MAPS_API_KEY){
        alert("Cl√© Google Maps manquante.");
        if(chk) chk.checked=false;
        return;
      }

      if(!viewerCesium) ensureCesium();
      try{
        if(!layersCesium.google3DTiles){
          const tiles = await Cesium.createGooglePhotorealistic3DTileset(window.GOOGLE_MAPS_API_KEY);
          layersCesium.google3DTiles = viewerCesium.scene.primitives.add(tiles);
          await tiles.readyPromise;
          viewerCesium.zoomTo(tiles);
          viewerCesium.scene.requestRender?.();
        }
      }catch(e){
        console.error("Google 3D Tiles:", e);
        alert("Impossible de charger Google Photorealistic 3D Tiles.");
        if(chk) chk.checked=false;
      }
    }

    /* ===========================
       TRAITEMENT PANEL
    ============================ */
    function toggleTraitement(){
      const p = document.getElementById("interfaceTraitement");
      if(!p) return;
      const show = (p.style.display === "none" || !p.style.display);
      p.style.display = show ? "block" : "none";
    }

    async function changerRendu(){
      const sel = document.getElementById("typeRendu");
      if(!sel) return;

      const v = sel.value;

      // Nettoyage DEM overlay si existant
      if(LAYERS.demProduct){
        map.removeLayer(LAYERS.demProduct);
        LAYERS.demProduct=null;
      }

      if(v === "ndvi"){
        await toggleNDVI(true);
        return;
      }
      if(v === "pente") await renderDemProduct("pente");
      if(v === "exposition") await renderDemProduct("exposition");
      if(v === "ombrage") await renderDemProduct("ombrage");
    }

    /* ===========================
       SIDEBAR
    ============================ */
    function toggleSidebar(){
      document.querySelector(".sidebar").classList.toggle("collapsed");
      setTimeout(() => map.invalidateSize(), 310);
    }

    /* ===========================
       INIT
    ============================ */
    async function init(){
      await toggleBoundary(true);
      await toggleNDVI(true);
      await toggleWaterPoints(true);
      map.fitBounds(ZAKOUMA_BOUNDS, { padding:[20,20] });
    }

    /* ===========================
       DOM READY (UNIQUE)
    ============================ */
    document.addEventListener("DOMContentLoaded", async () => {
      setDateHeader();

      if (location.protocol === "file:"){
        alert("‚ö†Ô∏è Ouvre via serveur local (ex: python3 -m http.server 5500). Sinon fetch() des rasters/geojson peut √™tre bloqu√©.");
      }

      try{
        await waitForLibs();
        initChart();
        await init();
      }catch(e){
        console.error(e);
        alert("Erreur chargement libs GeoTIFF/GeoRaster ou init.");
      }

      // Sidebar
      document.getElementById("toggleSidebarBtn").addEventListener("click", toggleSidebar);

      // Theme select
      document.getElementById("themeSelect").addEventListener("change", (e)=> changerTheme(e.target.value));

      // Base imagery
      document.getElementById("toggleBaseImagery").addEventListener("change", (e)=>{
        if(e.target.checked) map.addLayer(esriImagery); else map.removeLayer(esriImagery);
      });

      // Leaflet toggles
      document.getElementById("toggleBoundary").addEventListener("change", e=> toggleBoundary(e.target.checked));
      document.getElementById("toggleWaterPoints").addEventListener("change", e=> toggleWaterPoints(e.target.checked));
      document.getElementById("toggleNDVI").addEventListener("change", e=> toggleNDVI(e.target.checked));
      document.getElementById("toggleVCI").addEventListener("change", e=> toggleVCI(e.target.checked));
      document.getElementById("toggleVHI").addEventListener("change", e=> toggleVHI(e.target.checked));
      document.getElementById("toggleNDVICalc").addEventListener("change", e=> toggleNDVICalc(e.target.checked));

      document.getElementById("toggleSoilMoisture").addEventListener("change", e=> toggleSoilMoisture(e.target.checked));
      document.getElementById("toggleSurfaceWater").addEventListener("change", e=> toggleSurfaceWater(e.target.checked));
      document.getElementById("toggleFlood").addEventListener("change", e=> toggleFlood(e.target.checked));

      document.getElementById("toggleCorridors").addEventListener("change", e=> toggleCorridors(e.target.checked));
      document.getElementById("toggleTracks").addEventListener("change", e=> toggleTracks(e.target.checked));

      document.getElementById("toggleFires").addEventListener("change", e=> toggleFires(e.target.checked));
      document.getElementById("toggleSPI").addEventListener("change", e=> toggleSPI(e.target.checked));
      document.getElementById("toggleLST").addEventListener("change", e=> toggleLST(e.target.checked));

      document.getElementById("toggleRoads").addEventListener("change", e=> toggleRoads(e.target.checked));
      document.getElementById("toggleAgri").addEventListener("change", e=> toggleAgri(e.target.checked));

      // Region filter
      document.getElementById("filtreRegion").addEventListener("change", e=> filtrerParRegion(e.target.value));

      // Year filter buttons
      document.querySelectorAll(".btnYear").forEach(btn=>{
        btn.addEventListener("click", ()=> filterByYear(btn.dataset.year, btn));
      });
      document.getElementById("btnResetChart").addEventListener("click", resetChart);

      // Chart zoom
      document.getElementById("btnZoomChart").addEventListener("click", ouvrirGraphiqueZoom);

      // PDF export
      document.getElementById("btnExportPDF").addEventListener("click", exportPDF);

      // Traitement
      document.getElementById("btnToggleTraitement").addEventListener("click", toggleTraitement);
      document.getElementById("typeRendu").addEventListener("change", changerRendu);

      // 2D/3D toggle
      document.getElementById("btnToggle3DFixed").addEventListener("click", toggleCesium);

      // Cesium overlay toggles
      document.getElementById("togglePointCloud").addEventListener("change", e=> { if(!cesiumActive) toggleCesium(); togglePointCloudCesium(e.target.checked); });
      document.getElementById("toggleTerrainCustom").addEventListener("change", e=> { if(!cesiumActive) toggleCesium(); toggleTerrainCesium(e.target.checked); });
      document.getElementById("toggleBuildings3D").addEventListener("change", e=> { if(!cesiumActive) toggleCesium(); toggleBuildings3D(e.target.checked); });
      document.getElementById("toggleTrees3D").addEventListener("change", e=> { if(!cesiumActive) toggleCesium(); toggleTrees3D(e.target.checked); });

      // Google 3D safe
      const chkGoogle3D = document.getElementById("toggleGoogle3D");
      if (chkGoogle3D && !window.SAFE_HOSTS.has(location.hostname)){
        chkGoogle3D.closest("label")?.remove();
      } else if (chkGoogle3D){
        chkGoogle3D.addEventListener("change", e=> { if(!cesiumActive) toggleCesium(); toggleGoogle3DTiles(e.target.checked); });
      }
    });
  </script>
</body>
</html>